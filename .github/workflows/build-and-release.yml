name: ğŸš€ Build e Release ID Management System

on:
  push:
    tags:
      - 'v*.*.*'  # Dispara quando criar tag como v1.0.0
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o do release (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-windows:
    name: ğŸ—ï¸ Build Windows
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd frontend
        npm ci
    
    - name: ğŸ—ï¸ Build React App
      run: |
        cd frontend
        npm run build
    
    - name: âš¡ Build Electron App
      run: |
        cd frontend
        npm run electron:pack
    
    - name: ğŸ“‹ Criar arquivo de informaÃ§Ãµes
      run: |
        cd frontend/dist-electron
        $info = @"
        # ID Management System - v${{ github.ref_name }}
        
        ## ğŸ“ InstruÃ§Ãµes de InstalaÃ§Ã£o
        
        ### 1. Extrair
        - Extraia todos os arquivos em: C:\ID-Management\
        
        ### 2. Executar
        - Execute: ID Management System.exe
        - O app conecta automaticamente em: 192.168.1.52:8000
        
        ### 3. Servidor (Administrador)
        - Execute start-server.bat no PC servidor
        - Mantenha a janela aberta durante o uso
        
        ## ğŸ® Controles
        - ğŸ–¥ï¸ Trocar tamanho da janela
        - ğŸ“Œ PIN para manter na frente
        - Drag & Drop para upload de arquivos
        
        ## ğŸ“ Suporte
        Contato: BM Energia
        Data: $(Get-Date -Format "dd/MM/yyyy")
        "@
        $info | Out-File -FilePath "LEIA-ME.txt" -Encoding UTF8
    
    - name: ğŸ“¦ Criar ZIP do cliente
      run: |
        cd frontend/dist-electron
        Compress-Archive -Path "ID Management System-win32-x64\*" -DestinationPath "ID-Management-Cliente-Windows.zip" -Force
    
    - name: ğŸ“¦ Criar ZIP do servidor
      run: |
        $serverFiles = @(
          "start-server.bat",
          "stop-server.bat", 
          "status-server.bat",
          "backend\",
          "docker-compose.yml",
          "README.md"
        )
        
        Compress-Archive -Path $serverFiles -DestinationPath "ID-Management-Servidor.zip" -Force
    
    - name: ğŸ“‹ Gerar Release Notes
      id: release_notes
      run: |
        $notes = @"
        ## ğŸ‰ ID Management System ${{ github.ref_name }}
        
        ### ğŸ“¥ Downloads
        - **Cliente Windows**: ID-Management-Cliente-Windows.zip
        - **Servidor Completo**: ID-Management-Servidor.zip
        
        ### ğŸš€ Novidades desta versÃ£o
        - âœ… Interface desktop nativa com Electron
        - âœ… 3 tamanhos de janela predefinidos
        - âœ… Controles personalizados (PIN, minimizar, fechar)
        - âœ… Sistema de upload drag & drop
        - âœ… DetecÃ§Ã£o automÃ¡tica de tipos de arquivo
        - âœ… Estrutura de pastas espelho no servidor
        - âœ… Banco PostgreSQL centralizado
        
        ### ğŸ’» Requisitos
        - **Cliente**: Windows 10/11, Rede local
        - **Servidor**: Docker Desktop, Python 3.8+
        
        ### ğŸ› ï¸ InstalaÃ§Ã£o RÃ¡pida
        
        #### Para Clientes:
        1. Baixar: ID-Management-Cliente-Windows.zip  
        2. Extrair em: C:\ID-Management\
        3. Executar: ID Management System.exe
        
        #### Para Servidor:
        1. Baixar: ID-Management-Servidor.zip
        2. Extrair no PC servidor
        3. Executar: start-server.bat
        4. Manter janela aberta
        
        ### ğŸŒ ConfiguraÃ§Ã£o de Rede
        - **IP Servidor**: 192.168.1.52
        - **Porta API**: 8000
        - **Porta PostgreSQL**: 5432
        
        ---
        
        **ğŸ“ Suporte**: BM Energia  
        **ğŸ“… Data**: $(Get-Date -Format "dd/MM/yyyy HH:mm")
        "@
        
        $notes | Out-File -FilePath "release-notes.md" -Encoding UTF8
        echo "RELEASE_NOTES_PATH=release-notes.md" >> $env:GITHUB_OUTPUT
    
    - name: ğŸ·ï¸ Criar Release no GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "ID Management System ${{ github.ref_name }}"
        body_path: release-notes.md
        files: |
          frontend/dist-electron/ID-Management-Cliente-Windows.zip
          ID-Management-Servidor.zip
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: âœ… Build ConcluÃ­do
      run: |
        Write-Host "ğŸ‰ Build concluÃ­do com sucesso!" -ForegroundColor Green
        Write-Host "ğŸ“¦ Arquivos disponÃ­veis em: https://github.com/${{ github.repository }}/releases" -ForegroundColor Cyan
