name: ğŸš€ Build e Release ID Management System

on:
  push:
    tags:
      - 'v*.*.*'  # Dispara quando criar tag como v1.0.0
  
  # Permite execuÃ§Ã£o manual
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o do release (ex: v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write  # necessÃ¡rio para criar tag/release

jobs:
  build-windows:
    name: ğŸ—ï¸ Build Windows
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Definir TAG do release
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          echo "RELEASE_TAG=${{ github.event.inputs.version }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        }
        else {
          echo "RELEASE_TAG=${{ github.ref_name }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        }

    - name: ğŸ·ï¸ Criar tag (apenas em execuÃ§Ã£o manual)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      shell: pwsh
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag "$env:RELEASE_TAG"
        git push origin "$env:RELEASE_TAG"
    
    - name: ğŸŸ¢ Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        cd frontend
        npm ci
    
    - name: ğŸ—ï¸ Build React App
      run: |
        cd frontend
        npm run build

    - name: ğŸš€ Publicar artefatos (auto-update via electron-builder)
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd frontend
        # Extrair versÃ£o sem o prefixo 'v' da tag
        $version = $env:RELEASE_TAG -replace '^v',''
        echo "Empacotando e publicando versÃ£o $version"
        npm run electron:publish -- --config.extraMetadata.version=$version
    
    - name: âš¡ Build Electron App
      run: |
        cd frontend
        npm run electron:pack
    
    - name:  Criar ZIP do cliente
      run: |
        cd frontend/dist-electron
        Compress-Archive -Path "ID Management System-win32-x64" -DestinationPath "ID-Management-Cliente-Windows.zip" -Force
    
    - name: ğŸ“¦ Upload artifact (backup)
      uses: actions/upload-artifact@v4
      with:
        name: ID-Management-Cliente-Windows
        path: frontend/dist-electron/ID-Management-Cliente-Windows.zip
    
    - name: ğŸ·ï¸ Criar Release no GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "ID Management System ${{ env.RELEASE_TAG }}"
        body: |
          ## ğŸ‰ ID Management System ${{ github.ref_name }}
          
          ### ğŸ“¥ Downloads
          - **Instalador Windows (com auto-update)**: serÃ¡ anexado como `ID-Management-Setup-<versÃ£o>.exe` pelo electron-builder
          - **ZIP do cliente (backup)**: ID-Management-Cliente-Windows.zip
          
          ### ğŸš€ Novidades desta versÃ£o
          - âœ… Interface desktop nativa com Electron
          - âœ… 3 tamanhos de janela predefinidos
          - âœ… Controles personalizados (PIN, minimizar, fechar)
          - âœ… Sistema de upload drag & drop
          - âœ… DetecÃ§Ã£o automÃ¡tica de tipos de arquivo
          - âœ… Estrutura de pastas espelho no servidor
          - âœ… Banco PostgreSQL centralizado
          
          ### ğŸ’» Requisitos
          - **Cliente**: Windows 10/11, Rede local
          - **Servidor**: Docker Desktop, Python 3.8+
          
          ### ğŸ› ï¸ InstalaÃ§Ã£o RÃ¡pida
          
          #### Para Clientes:
          1. Baixar: ID-Management-Cliente-Windows.zip  
          2. Extrair em: C:\ID-Management\
          3. Executar: ID Management System.exe
          4. App: configurar `%USERPROFILE%\\.id-management-config.json` com `{ "host": "SEU_IP_DO_SERVIDOR", "port": 8000, "protocol": "http" }`
          
          ### ğŸŒ ConfiguraÃ§Ã£o de Rede
          - **IP Servidor**: SEU_IP (ex.: 192.168.1.54)
          - **Porta API**: 8000
          - **Porta PostgreSQL**: 5432
        files: |
          frontend/dist-electron/ID-Management-Cliente-Windows.zip
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
